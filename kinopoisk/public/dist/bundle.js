(()=>{var e={143:()=>{var e;e=Handlebars.template,(Handlebars.templates=Handlebars.templates||{}).Button=e({compiler:[8,">= 4.3.0"],main:function(e,t,n,a,s){var r,i=null!=t?t:e.nullContext||{},o=e.hooks.helperMissing,l="function",c=e.escapeExpression,d=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<button id="'+c(typeof(r=null!=(r=d(n,"id")||(null!=t?d(t,"id"):t))?r:o)===l?r.call(i,{name:"id",hash:{},data:s,loc:{start:{line:1,column:12},end:{line:1,column:18}}}):r)+'" class="'+c(typeof(r=null!=(r=d(n,"classname")||(null!=t?d(t,"classname"):t))?r:o)===l?r.call(i,{name:"classname",hash:{},data:s,loc:{start:{line:1,column:27},end:{line:1,column:42}}}):r)+'" type="'+c(typeof(r=null!=(r=d(n,"type")||(null!=t?d(t,"type"):t))?r:o)===l?r.call(i,{name:"type",hash:{},data:s,loc:{start:{line:1,column:50},end:{line:1,column:58}}}):r)+'">'+c(typeof(r=null!=(r=d(n,"text")||(null!=t?d(t,"text"):t))?r:o)===l?r.call(i,{name:"text",hash:{},data:s,loc:{start:{line:1,column:60},end:{line:1,column:70}}}):r)+"</button>"},useData:!0}),function(){const{template:e}=Handlebars;(Handlebars.templates=Handlebars.templates||{}).Window=e({compiler:[8,">= 4.3.0"],main:(e,t,n,a,s)=>'<div class="okno" id="okno">\n</div>',useData:!0})}(),function(){var e=Handlebars.template;(Handlebars.templates=Handlebars.templates||{}).FilmCard=e({1:function(e,t,n,a,s){var r=e.lambda,i=e.escapeExpression,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'                        <a href="genre/'+i(r(null!=t?o(t,"genre"):t,t))+'" class="link"> '+i(r(null!=t?o(t,"rusGenre"):t,t))+" </a>\n"},3:function(e,t,n,a,s){var r=e.lambda,i=e.escapeExpression,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'                        <a href="person/'+i(r(null!=t?o(t,"Id"):t,t))+'" class="link">'+i(r(null!=t?o(t,"Name"):t,t))+" </a>\n"},5:function(e,t,n,a,s){return"                    "+e.escapeExpression(e.lambda(t,t))+",\n"},7:function(e,t,n,a,s){var r,i,o=null!=t?t:e.nullContext||{},l=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'                <div class="rating-area">\n'+(null!=(r=l(n,"each").call(o,null!=t?l(t,"stars"):t,{name:"each",hash:{},fn:e.program(8,s,0),inverse:e.noop,data:s,loc:{start:{line:35,column:20},end:{line:38,column:29}}}))?r:"")+"                </div>\n                "+(null!=(r="function"==typeof(i=null!=(i=l(n,"Button")||(null!=t?l(t,"Button"):t))?i:e.hooks.helperMissing)?i.call(o,{name:"Button",hash:{},data:s,loc:{start:{line:40,column:16},end:{line:40,column:30}}}):i)?r:"")+"\n"},8:function(e,t,n,a,s){var r=e.lambda,i=e.escapeExpression;return'                        <input type="radio" id="star-'+i(r(t,t))+'" name="rating" value="'+i(r(t,t))+'">\n                        <label for="star-'+i(r(t,t))+'" title="Оценка «'+i(r(t,t))+'»"></label>\n'},compiler:[8,">= 4.3.0"],main:function(e,t,n,a,s){var r,i,o=null!=t?t:e.nullContext||{},l=e.hooks.helperMissing,c="function",d=e.escapeExpression,m=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="poster">\n    <div class="header">\n        <a href="#" class="header-link">\n            <b>'+d(typeof(i=null!=(i=m(n,"title")||(null!=t?m(t,"title"):t))?i:l)===c?i.call(o,{name:"title",hash:{},data:s,loc:{start:{line:4,column:15},end:{line:4,column:26}}}):i)+'</b>\n        </a>\n    </div>\n    <div class="poster-body">\n        <div class="left-block">\n                <iframe width="560" height="315" src="'+d(typeof(i=null!=(i=m(n,"youtube")||(null!=t?m(t,"youtube"):t))?i:l)===c?i.call(o,{name:"youtube",hash:{},data:s,loc:{start:{line:9,column:54},end:{line:9,column:67}}}):i)+'" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>\n            <div> <span class="rating">Рейтинг: '+d(typeof(i=null!=(i=m(n,"rate")||(null!=t?m(t,"rate"):t))?i:l)===c?i.call(o,{name:"rate",hash:{},data:s,loc:{start:{line:10,column:48},end:{line:10,column:58}}}):i)+'</span><span class="votes">'+d(typeof(i=null!=(i=m(n,"votes")||(null!=t?m(t,"votes"):t))?i:l)===c?i.call(o,{name:"votes",hash:{},data:s,loc:{start:{line:10,column:85},end:{line:10,column:96}}}):i)+' голосов</span></div>\n        </div>\n        <div class="right-block">\n            <div class="desc">\n                '+d(typeof(i=null!=(i=m(n,"description")||(null!=t?m(t,"description"):t))?i:l)===c?i.call(o,{name:"description",hash:{},data:s,loc:{start:{line:14,column:16},end:{line:14,column:33}}}):i)+'\n            </div>\n            <div class="desc info">\n                <div>\n                    <b>Жанр:</b>\n'+(null!=(r=m(n,"each").call(o,null!=t?m(t,"genres"):t,{name:"each",hash:{},fn:e.program(1,s,0),inverse:e.noop,data:s,loc:{start:{line:19,column:20},end:{line:21,column:29}}}))?r:"")+'                </div>\n                <div class="roles">\n                    <b>В ролях:</b>\n'+(null!=(r=m(n,"each").call(o,null!=t?m(t,"actors"):t,{name:"each",hash:{},fn:e.program(3,s,0),inverse:e.noop,data:s,loc:{start:{line:25,column:20},end:{line:27,column:29}}}))?r:"")+"                </div>\n"+(null!=(r=m(n,"each").call(o,null!=t?m(t,"countries"):t,{name:"each",hash:{},fn:e.program(5,s,0),inverse:e.noop,data:s,loc:{start:{line:29,column:16},end:{line:31,column:25}}}))?r:"")+"            </div>\n"+(null!=(r=m(n,"if").call(o,null!=t?m(t,"isAuth"):t,{name:"if",hash:{},fn:e.program(7,s,0),inverse:e.noop,data:s,loc:{start:{line:33,column:12},end:{line:41,column:19}}}))?r:"")+"        </div>\n    </div>\n</div>"},useData:!0})}(),function(){var e=Handlebars.template;(Handlebars.templates=Handlebars.templates||{}).FilmPoster=e({compiler:[8,">= 4.3.0"],main:function(e,t,n,a,s){var r,i=null!=t?t:e.nullContext||{},o=e.hooks.helperMissing,l="function",c=e.escapeExpression,d=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="lenta__object">\n    <a href="film/'+c(typeof(r=null!=(r=d(n,"id")||(null!=t?d(t,"id"):t))?r:o)===l?r.call(i,{name:"id",hash:{},data:s,loc:{start:{line:2,column:18},end:{line:2,column:26}}}):r)+'" class="href" id="'+c(typeof(r=null!=(r=d(n,"id")||(null!=t?d(t,"id"):t))?r:o)===l?r.call(i,{name:"id",hash:{},data:s,loc:{start:{line:2,column:45},end:{line:2,column:53}}}):r)+'"><img width="270" height="420" src="'+c(typeof(r=null!=(r=d(n,"SmallImg")||(null!=t?d(t,"SmallImg"):t))?r:o)===l?r.call(i,{name:"SmallImg",hash:{},data:s,loc:{start:{line:2,column:90},end:{line:2,column:104}}}):r)+'" alt="" class="object__image">\n        <div class="object__hidden"><span>'+c(typeof(r=null!=(r=d(n,"MainGenre")||(null!=t?d(t,"MainGenre"):t))?r:o)===l?r.call(i,{name:"MainGenre",hash:{},data:s,loc:{start:{line:3,column:42},end:{line:3,column:57}}}):r)+", "+c(typeof(r=null!=(r=d(n,"year")||(null!=t?d(t,"year"):t))?r:o)===l?r.call(i,{name:"year",hash:{},data:s,loc:{start:{line:3,column:59},end:{line:3,column:69}}}):r)+' год</span></div>\n    </a>\n    <div class="image__text"> '+c(typeof(r=null!=(r=d(n,"title")||(null!=t?d(t,"title"):t))?r:o)===l?r.call(i,{name:"title",hash:{},data:s,loc:{start:{line:5,column:30},end:{line:5,column:41}}}):r)+" </div>\n</div>"},useData:!0})}(),function(){const{template:e}=Handlebars;(Handlebars.templates=Handlebars.templates||{}).FilmLenta=e({1(e,t,n,a,s){let r;return`        ${null!=(r=e.lambda(t,t))?r:""}\n`},compiler:[8,">= 4.3.0"],main(e,t,n,a,s){let r,i;const o=null!=t?t:e.nullContext||{},l=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return`<h1 class="main__header">${e.escapeExpression((i=null!=(i=l(n,"genre")||(null!=t?l(t,"genre"):t))?i:e.hooks.helperMissing,"function"==typeof i?i.call(o,{name:"genre",hash:{},data:s,loc:{start:{line:1,column:25},end:{line:1,column:36}}}):i))}</h1>\n<div class="header__lenta">\n${null!=(r=l(n,"each").call(o,null!=t?l(t,"posters"):t,{name:"each",hash:{},fn:e.program(1,s,0),inverse:e.noop,data:s,loc:{start:{line:3,column:4},end:{line:5,column:13}}}))?r:""}</div>`},useData:!0})}(),function(){var e=Handlebars.template;(Handlebars.templates=Handlebars.templates||{}).Footer=e({compiler:[8,">= 4.3.0"],main:function(e,t,n,a,s){return'<footer id="footer" class="custom__footer">\n    <div class="footer__text">By Ruiners: Kinopark 2020 </div>\n</footer>'},useData:!0})}(),function(){var e=Handlebars.template;(Handlebars.templates=Handlebars.templates||{}).Comments=e({1:function(e,t,n,a,s){var r,i,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <h1 class="myComment__header">Ваш отзыв</h1>\n    <div class="myComment__underground">\n        <form>\n            <textarea name="message" rows="1" class="question" required="" autocomplete="off" id="msg"></textarea>\n            <label class="comment" for="msg"><span class="comment">Напишите отзыв..</span></label>\n        </form>\n        '+(null!=(r="function"==typeof(i=null!=(i=o(n,"Button")||(null!=t?o(t,"Button"):t))?i:e.hooks.helperMissing)?i.call(null!=t?t:e.nullContext||{},{name:"Button",hash:{},data:s,loc:{start:{line:8,column:8},end:{line:8,column:22}}}):i)?r:"")+"\n    </div>\n"},3:function(e,t,n,a,s){return'    <h1 class="myComment__header">Нет отзывов</h1>\n'},5:function(e,t,n,a,s){var r,i=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <h1 class="myComment__header">Все отзывы</h1>\n'+(null!=(r=i(n,"each").call(null!=t?t:e.nullContext||{},null!=t?i(t,"comments"):t,{name:"each",hash:{},fn:e.program(6,s,0),inverse:e.noop,data:s,loc:{start:{line:15,column:4},end:{line:27,column:13}}}))?r:"")},6:function(e,t,n,a,s){var r=e.lambda,i=e.escapeExpression,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'        <div class="myComment__underground">\n            <a class="profile__comment" href="">\n                <span class="login__comment">'+i(r(null!=t?o(t,"UserLogin"):t,t))+'</span>\n                <img class="profile__round" width="50" height="50" src="'+i(r(null!=t?o(t,"Image"):t,t))+'" alt="">\n            </a>\n            <div class="comment__content">\n                '+i(r(null!=t?o(t,"TextBody"):t,t))+'\n            </div>\n            <hr class="myLine">\n            <span class="comment__rate">Оценка: '+i(r(null!=t?o(t,"Rate"):t,t))+"/10</span>\n        </div>\n"},compiler:[8,">= 4.3.0"],main:function(e,t,n,a,s){var r,i=null!=t?t:e.nullContext||{},o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return(null!=(r=o(n,"if").call(i,null!=t?o(t,"isAuth"):t,{name:"if",hash:{},fn:e.program(1,s,0),inverse:e.noop,data:s,loc:{start:{line:1,column:0},end:{line:10,column:7}}}))?r:"")+(null!=(r=o(n,"if").call(i,null!=t?o(t,"noComments"):t,{name:"if",hash:{},fn:e.program(3,s,0),inverse:e.program(5,s,0),data:s,loc:{start:{line:11,column:0},end:{line:28,column:7}}}))?r:"")},useData:!0})}(),function(){var e=Handlebars.template;(Handlebars.templates=Handlebars.templates||{}).PersonCard=e({compiler:[8,">= 4.3.0"],main:function(e,t,n,a,s){var r,i=null!=t?t:e.nullContext||{},o=e.hooks.helperMissing,l="function",c=e.escapeExpression,d=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <link rel="stylesheet" href="../../Actor.css">\n    <title>Title</title>\n</head>\n<body>\n<div class="actor__main">\n    <div>\n        <img width="250", height="300" src="'+c(typeof(r=null!=(r=d(n,"Image")||(null!=t?d(t,"Image"):t))?r:o)===l?r.call(i,{name:"Image",hash:{},data:s,loc:{start:{line:11,column:44},end:{line:11,column:53}}}):r)+'" class="person__image">\n    </div>\n    <div class="person__info">\n        <div class="person__name">\n            '+c(typeof(r=null!=(r=d(n,"Name")||(null!=t?d(t,"Name"):t))?r:o)===l?r.call(i,{name:"Name",hash:{},data:s,loc:{start:{line:15,column:12},end:{line:15,column:20}}}):r)+'\n        </div>\n        <div class="person__date">\n            <span class="person__headers">Дата рождения:</span>'+c(typeof(r=null!=(r=d(n,"BornDate")||(null!=t?d(t,"BornDate"):t))?r:o)===l?r.call(i,{name:"BornDate",hash:{},data:s,loc:{start:{line:18,column:63},end:{line:18,column:75}}}):r)+'\n        </div>\n        <div class="person__date">\n            <span class="person__headers">Место рождения:</span>'+c(typeof(r=null!=(r=d(n,"BornPlace")||(null!=t?d(t,"BornPlace"):t))?r:o)===l?r.call(i,{name:"BornPlace",hash:{},data:s,loc:{start:{line:21,column:64},end:{line:21,column:77}}}):r)+"\n        </div>\n    </div>\n</div>\n</body>\n</html>"},useData:!0})}()}},t={};function n(a){if(t[a])return t[a].exports;var s=t[a]={exports:{}};return e[a](s,s.exports,n),s.exports}(()=>{"use strict";class e{constructor(e){this.link=e}render(e,t){this.link.addEventListener(""+e,(e=>{e.preventDefault(),t()}))}}class t{constructor(e){const{parent:t,classname:n}=e;this.li=document.createElement("li"),this.parent=t,this.classname=n}render(){return this.parent.appendChild(this.li),this.li.className=this.classname,this.li}placeContent(e){this.li.innerHTML=e}}class a{constructor(e){const{parent:t,classname:n,pathname:a}=e;this.a=document.createElement("a"),this.parent=t,this.classname=n,this.pathname=a}render(){return this.a.className=this.classname,this.a.href=this.pathname,this.parent.appendChild(this.a),this.a}placeContent(e){return this.a.innerHTML=e,this.a}}class s{constructor(e){this.parent=e}render(){const e=document.createElement("nav");return this.parent.appendChild(e),e}}n(143);class r{constructor(e={}){const{classname:t,text:n,parent:a,type:s,id:r}=e;this.button=document.createElement("div"),this.classname=t,this.text=n,this.parent=a,this.template=Handlebars.templates.Button,this.type=s,this.id=r}render(e){this.parent.appendChild(this.button),this.button.innerHTML=this.template({classname:this.classname,type:this.type,text:this.text,id:this.id}),this.button.addEventListener("click",(t=>{t.preventDefault(),e(t)}))}renderSubmit(){this.button=document.createElement("button"),this.button.className=this.classname,this.button.textContent=this.text,this.button.type=this.type,this.parent.appendChild(this.button)}}const i=new class{constructor(){this.listeners={}}on(e,t){this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(t)}off(e,t){this.listeners[e]=this.listeners[e].filter((function(e){return e!==t}))}emit(e,t){this.listeners[e].forEach((function(e){e(t)}))}};class o{constructor(e={}){const{parent:t}=e;this.parent=t,this.windowEl=document.createElement("div"),this.template=Handlebars.templates.Window}render(e){this.parent.appendChild(this.windowEl),this.windowEl.innerHTML=this.template();const t=document.getElementById("okno"),n=new r({parent:t,classname:"buttons",text:"Профиль"}),a=new r({parent:t,classname:"buttons",text:"Настройки"});n.render((()=>{i.emit("loginPasswordChange",n)})),a.render((()=>{i.emit("Change",a)}))}close(){this.windowEl.innerHTML=""}}const l="http://localhost:8000";window.domain=l;class c{static ajaxGet(e){return this.ajax({method:"GET",...e})}static ajaxPost(e){return this.ajax({method:"POST",...e})}static ajax({method:e="GET",url:t="/",body:n=null}={}){const a={method:e,credentials:"include",mode:"cors"};return n&&(n instanceof FormData?a.body=n:(a.body=JSON.stringify(n),a.headers={"Content-Type":"application/json"})),fetch(l+t,a)}}class d{static async fetchLogin(e,t){return(await c.ajaxPost({url:"/login",body:{login:e,password:t}})).status}static async fetchSignup(e,t,n){return(await c.ajaxPost({url:"/signup",body:{login:e,email:t,password:n}})).status}static async fetchLogout(){return(await c.ajaxGet({url:"/logout"})).status}static async fetchMe(){const e=await c.ajaxGet({url:"/me"}),t=await e.json();return{status:e.status,json:t}}static async login(e,t){const n={ok:!1,errmsg:void 0};return""===e&&(n.errmsg="Пустой логин"),""===t&&(n.errmsg="Пустой пароль"),200!==await this.fetchLogin(e,t)?n.errmsg="Неправильное имя пользователя или пароль":n.ok=!0,n}static async signup(e,t,n){const a={ok:!1,errmsg:void 0};return""===e&&(a.errmsg="Пустой логин"),""===t&&(a.errmsg="Пустой email"),""===n&&(a.errmsg="Пустой пароль"),200!==await this.fetchSignup(e,t,n)?a.errmsg="Пользователь с таким логином уже существует":a.ok=!0,a}static async logout(){const e={ok:!1,errmsg:void 0};return 200!==await this.fetchLogout()?e.errmsg="bad request":e.ok=!0,e}static async me(){const e={ok:!1,errmsg:void 0,get:void 0},t=await this.fetchMe();return 200!==t.status?e.errmsg="bad request":(e.ok=!0,e.get=t.json),e}}class m{constructor(e){this.parent=e}render(n,l){nav.innerHTML="";const c=new s(this.parent).render(),m=document.createElement("ul");c.appendChild(m);const u=new t({parent:m,classname:"brand"}).render(),p=document.createElement("a");p.innerHTML='KINO <img width="25", height="25" src="../static/images/icons8-кинопроектор-96.png"/> PARK',u.appendChild(p);const h=new e(p);i.emit("navbarClick",h);const g=new t({parent:m,classname:"menu-secondary"}).render(),y=new a({parent:g,pathname:"/",classname:""});if(y.render(),y.placeContent("Фильмы"),n){const n=new t({parent:m,classname:"right"}).render(),s=new a({parent:n,className:"profileNav"}),c=s.render(),u=domain+"/user/avatar/"+l.get.id+"?"+Math.random();s.placeContent(`<img width="50" height="50" src="${u}" alt="" class="round">`);const p=new e(c),h=new o({parent:c});let g=0;p.render("click",(()=>{g+=1,g%2==1?h.render((()=>{})):h.close()}));const y=new t({parent:n,classname:""}).render();new r({parent:y,classname:"buttons",text:"Выйти"}).render((e=>{d.logout().then((e=>{this.render(!1,0),i.emit("logout",e)}))}))}else{const e=new t({parent:m,classname:"right"}).render(),n=new r({parent:e,classname:"buttons",text:"Войти"});i.emit("navbarLogin",n);const a=new t({parent:e,classname:""}).render(),s=new r({parent:a,classname:"buttons",text:"Зарегистрироваться"});i.emit("navbarSignup",s)}}}class u{constructor(){this.footer=document.createElement("div"),this.template=Handlebars.templates.Footer}render(){const e=document.getElementById("footer");null!=e&&(e.innerHTML=""),this.footer.innerHTML=this.template(),document.getElementById("body").appendChild(this.footer)}}class p{constructor(e){this.parent=e}render(e){document.getElementById("body").style.backgroundImage="none",(e||""==nav.innerText)&&this.createNavbar()}createNavbar(){nav.innerHTML="";let e=!1;console.log("online =",navigator.onLine),navigator.onLine?d.me().then((t=>{console.log(t),e=!!t.ok,new m(nav).render(e,t)})):new m(nav).render(e,{})}createFooter(){(new u).render()}}class h{static async fetchRate(e,t){return(await c.ajaxPost({url:"/rate",body:{filmId:e,rating:t}})).status}static async Rate(e,t){const n={ok:!1,errmsg:void 0};return 200!==await this.fetchRate(e,t)?n.errmsg="Ошибка оценки":n.ok=!0,n}}class g{constructor(e={}){const{parent:t,body:n,isAuthorized:a,actors:s}=e;this.card=document.createElement("div"),this.parent=t,this.body=n,this.isAuthorized=a,this.actors=s,this.voteButton=new r({classname:"buttons buttons__forComments",parent:null}),this.template=Handlebars.templates.FilmCard,this.mapRussian=[],this.mapRussian["Фантастика"]="fantasy",this.mapRussian["Комедия"]="comedy"}render(){this.parent.appendChild(this.card),this.card.innerHTML=this.template({isAuth:this.isAuthorized,title:this.body.title,description:this.body.Description,youtube:this.body.YoutubeLink,genres:[{rusGenre:this.body.MainGenre,genre:this.mapRussian[this.body.MainGenre]}],actors:this.actors,countries:[this.body.country],rate:this.body.Rating,votes:this.body.SumVotes,stars:[10,9,8,7,6,5,4,3,2,1],Button:this.voteButton.template({classname:"buttons buttons__marginForFilmCard",text:"Оценить",id:"vote",type:"submit"})});const e=document.getElementById("vote"),t=document.createElement("div");t.className="success succes__marginForFilmCard",this.isAuthorized&&e.addEventListener("click",(e=>{for(let e=1;e<=10;e++)document.getElementById("star-"+e).checked&&h.Rate(this.body.id,e).then((e=>{e.ok&&(t.textContent="Вы успешно проголосовали!",this.card.appendChild(t))}))}))}}class y{constructor(e={}){const{parent:t,body:n,isAuthorized:a}=e;this.comments=document.createElement("div"),this.parent=t,this.body=n,this.isAuthorized=a,this.msgButton=new r({classname:"buttons buttons__marginForFilmCard",id:"msg_button",parent:null}),this.template=Handlebars.templates.Comments}render(){this.parent.appendChild(this.comments);let e=!0;0!==this.body.length&&(e=!1),this.comments.innerHTML=this.template({noComments:e,isAuth:this.isAuthorized,comments:this.body,Button:this.msgButton.template({classname:"buttons buttons__forComments",text:"Отправить",id:"msg_button",type:"submit"})})}hide(){this.comments.innerHTML=""}}class f{static async fetchGetById(e){const t=await c.ajaxGet({url:"/film/"+e}),n=await t.json();return{status:t.status,json:n}}static async fetchGetByGenre(e){const t=await c.ajaxGet({url:"/film/"+e}),n=await t.json();return{status:t.status,json:n}}static async fetchGetByPerson(e){const t=await c.ajaxGet({url:"/person_film/"+e}),n=await t.json();return{status:t.status,json:n}}static async fetchPostReview(e,t){return(await c.ajaxPost({url:"/review/add",body:{filmId:e,body:t}})).status}static async fetchGetByReviews(e){const t=await c.ajaxGet({url:"/review/"+e}),n=await t.json();return{status:t.status,json:n}}static async getById(e){const t={ok:!1,errmsg:void 0,get:void 0},n=await this.fetchGetById(e);return 200!==n.status?t.errmsg="Нет такого фильма":(t.ok=!0,t.get=n.json),t}static async getByGenre(e){const t={ok:!1,errmsg:void 0,get:void 0},n=await this.fetchGetByGenre(e);return 200!==n.status?t.errmsg="Пусто":(t.ok=!0,t.get=n.json),t}static async getByPerson(e){const t={ok:!1,errmsg:void 0,get:void 0},n=await this.fetchGetByPerson(e);return 200!==n.status?t.errmsg="Пусто":(t.ok=!0,t.get=n.json),t}static async PostReview(e,t){const n={ok:!1,errmsg:void 0};return""===t&&(n.errmsg="Пустое поле"),200!==await this.fetchPostReview(e,t)?n.errmsg="хз":n.ok=!0,n}static async getByReviews(e){const t={ok:!1,errmsg:void 0,get:void 0},n=await this.fetchGetByReviews(e);return 200!==n.status?t.errmsg="Пусто":(t.ok=!0,t.get=n.json),t}}class v{static async fetchGetById(e){const t=await c.ajaxGet({url:"/person/"+e}),n=await t.json();return{status:t.status,json:n}}static async fetchGetByFilmId(e,t){const n=await c.ajaxGet({url:"/"+t+"/"+e}),a=await n.json();return{status:n.status,json:a}}static async getById(e){const t={ok:!1,errmsg:void 0,get:void 0},n=await this.fetchGetById(e);return 200!==n.status?t.errmsg="Нет такого актера":(t.ok=!0,t.get=n.json),t}static async getByFilmId(e,t){const n={ok:!1,errmsg:void 0,get:void 0},a=await this.fetchGetByFilmId(e,t);return 200!==a.status?n.errmsg="Ошибка":(n.ok=!0,n.get=a.json),n}}class b extends p{constructor(e={}){super(nav);const{parent:t,body:n,isAuthorized:a}=e;this.parent=t,this.body=n,this.isAuthorized=a,console.log("isAuth = ",this.isAuthorized)}render(){super.render(!1);const e=document.getElementById("body");e.className="film1";let t=JSON.parse(this.body);e.style.backgroundImage=`linear-gradient(to top, #2e2e2e 0%, rgba(0,0,0,0.1) 40%), url(${t.BigImg})`,this.parent.innerHTML="",this.parent.className="",v.getByFilmId(t.id,"actor").then((e=>{let n;if(e.ok){try{n=JSON.parse(JSON.stringify(e.get))}catch(e){i.emit("main")}new g({isAuthorized:this.isAuthorized,parent:this.parent,body:t,actors:n}).render()}f.getByReviews(t.id).then((e=>{let n;try{n=JSON.parse(JSON.stringify(e.get))}catch(e){i.emit("main")}for(let e=0;e<n.length;e++)n[e].Image=`${domain}/user/avatar/${n[e].UserId+"?"+Math.random()}`;if(new y({isAuthorized:this.isAuthorized,parent:this.parent,body:n}).render(),this.isAuthorized){const e=document.getElementById("msg_button");e.addEventListener("click",(n=>{const a=document.getElementById("msg");if(""==a.value){const t=e.parentElement,n=document.createElement("div");n.textContent="Пустой отзыв",n.className="error",t.appendChild(n)}else f.PostReview(t.id,a.value).then((e=>{this.render()}))}))}}))}))}}function w(e,t){const n=document.createElement("div");return n.className=e,t.appendChild(n),n}class x{createInput(e,t,n){const a=document.createElement("input");return a.type=e,a.name=t,a.placeholder=n,a}valid(e,t,n,a){const s=w("error",e);n.onblur=function(){t.test(this.value)||(this.classList.add("invalid"),s.innerHTML=a)},n.onfocus=function(){this.classList.contains("invalid")&&(this.classList.remove("invalid"),s.innerHTML="")}}constructor(e,t,n){this.headConf=e,this.configInput=t,this.sub=n}render(){const{head:e,textContent:t,style:n}=this.headConf,a=document.createElement("form"),s=[];if(s.push(a),e){const e=document.createElement("h2");e.textContent=t,e.style=n,a.appendChild(e)}this.configInput.forEach((e=>{const{type:t,name:n,text:r,required:i}=e,o=this.createInput(t,n,r);o.required=i,a.appendChild(o),s.push(o)}));const{text:i,className:o}=this.sub;new r({parent:a,text:i,classname:"buttons buttons__margin",type:"submit"}).renderSubmit();let l=1;return this.configInput.forEach((e=>{const{reg:t,errorVal:n}=e;e.valid&&this.valid(a,t,s[l],n),l+=1})),s}}class C extends p{constructor(e){super(nav),this.parent=e}render(){super.render(!1),this.parent.innerHTML="";const t=document.getElementById("body");t.className="page",t.style.backgroundImage="url('../static/images/login.jpg')",this.parent.className="wrapper__form__regLog register";const n=new x({head:!0,textContent:"Регистрация",style:"color:#FFFFFF; margin-left: 10px"},[{type:"login",name:"login",text:"Логин",required:!0,valid:!0,reg:/[A-Za-z0-9]{5,15}/,errorVal:"Недопустимый логин(Должен быть от 5 до 15 символов)"},{type:"email",name:"email",text:"e-mail",required:!0,valid:!1},{type:"password",name:"password",text:"Пароль",required:!0,valid:!0,reg:/.{8,16}/,errorVal:"Недопустимый пароль(Должен быть от 8 до 16 символов)"}],{text:"Регистрация",className:"secondary"}).render(),s=n[0];this.parent.appendChild(s);const r=new a({parent:s,classname:"linkSignupLogin",pathname:"/login"});r.render(),r.placeContent("Войти в имеющийся аккаунт");const o=new e(s),l=document.createElement("div");l.className="error",o.render("submit",(()=>{if(!n[1].classList.contains("invalid")&&!n[3].classList.contains("invalid")){const e=n[1].value.trim(),t=n[3].value.trim(),a=n[2].value.trim();d.signup(e,a,t).then((e=>{i.emit("loginSignup",{loginres:e,err:l,form:s})}))}}))}}class k extends p{constructor(e){super(nav),this.parent=e}render(){super.render(!1),this.parent.innerHTML="";const t=document.getElementById("body");t.className="page",t.style.backgroundImage="url('../static/images/login.jpg')",this.parent.className="wrapper__form__regLog login";const n=new x({head:!0,textContent:"Вход",style:"color:#FFFFFF; margin-left: 10px"},[{type:"login",name:"login",text:"Логин",required:!0,valid:!1},{type:"password",name:"password",text:"Пароль",required:!0,valid:!1}],{text:"Войти",className:"secondary"}).render(),s=n[0];this.parent.appendChild(s);const r=new e(s),o=document.createElement("div");o.className="error",r.render("submit",(()=>{const e=n[1].value.trim(),t=n[2].value.trim();d.login(e,t).then((e=>{i.emit("loginSignup",{loginres:e,err:o,form:s})}))}));const l=new a({parent:s,classname:"linkSignupLogin",pathname:"/signup"});l.render(),l.placeContent("Создать новый аккаунт"),new e(l.a)}}const P={rech:{href:"/rech",text:"Рецензии"},mark:{href:"/mark",text:"Оценки"},films:{href:"/films",text:"Фильмы"},stars:{href:"/stars",text:"Звёзды"}};class _ extends p{constructor(e,t){super(nav),this.parent=e,this.data=t}render(){const t=JSON.parse(this.data);super.render(!1);const n=document.getElementById("body");n.className="page",n.style.backgroundImage="url('../static/images/login.jpg')";const s=w("shadow profile",this.parent),r=document.createElement("ul");r.className="top-menu",s.appendChild(r);const o=document.createElement("li"),l=document.createElement("span");l.textContent="Профиль",o.appendChild(l),r.appendChild(o),Object.keys(P).forEach((e=>{const{href:t,text:n}=P[e],s=document.createElement("li"),i=new a({parent:s,classname:""});i.a.dataset.section=e,i.render(),i.placeContent(n),r.appendChild(s)}));const c=w("profileInfoWrapLeft",s),d=w("avatarUserBoxP",c),m=document.createElement("img");m.src=`${domain}/user/avatar/${t.id+"?"+Math.random()}`,m.height=300,m.width=300,m.className="avatar__image",d.appendChild(m);const u=document.createElement("button");u.className="buttons buttons__marginForSettings",u.textContent="Изменить данные",u.href="/";const p=new e(u);i.emit("profileChange",p),c.appendChild(u);const h=w("profileInfoWrapRight",s),g=w("infoUser",h),y=document.createElement("h1");y.className="profile__nickname",y.textContent=""+t.Login,g.appendChild(y)}}class E{static async fetchChangeLogin(e){return(await c.ajaxPost({url:"/chengelogin",body:{login:e}})).status}static async fetchChangePassword(e,t){return console.log({PasswordOld:e,Password:t}),(await c.ajaxPost({url:"/chengepass",body:{PasswordOld:e,Password:t}})).status}static async fetchChangeAvatar(e){return(await c.ajaxPost({url:"/changeAvatar",body:e})).status}static async ChangeLogin(e){const t={ok:!1,errmsg:void 0};return""===e&&(t.errmsg="Пустой логин"),200!==await this.fetchChangeLogin(e)?t.errmsg="Пользователь с таким логином уже сущетсвует":t.ok=!0,t}static async ChangePassword(e,t){const n={ok:!1,errmsg:void 0};return""===e&&(n.errmsg="Пустой старый пароль"),""===t&&(n.errmsg="Пустой новый пароль"),200!==await this.fetchChangePassword(e,t)?n.errmsg="Неправильный старый пароль":n.ok=!0,n}static async ChangeAvatar(e){const t={ok:!1,errmsg:void 0};return 200!==await this.fetchChangeAvatar(e)?t.errmsg="Ошибка":t.ok=!0,t}}class B extends p{constructor(e,t){super(nav),this.parent=e,this.data=t}render(){super.render(!1);const t=document.getElementById("body");t.className="page",t.style.backgroundImage="url('../static/images/login.jpg')",this.parent.className="wrapper__form chenge margin";const n=[{type:"login",name:"login",text:""+JSON.parse(this.data).Login,required:!0,valid:!0,reg:/[A-Za-z0-9]{5,15}/,errorVal:"Недопустимый логин(Должен быть от 5 до 15 символов)"}],a=new x({head:!0,textContent:"Настройки пользователя",style:"color:#FFFFFF; margin-left: 10px"},n,{text:"Изменить логин",className:"secondary"}).render(),s=a[0];this.parent.appendChild(s),new e(s).render("submit",(()=>{if(!a[1].classList.contains("invalid")){const e=a[1].value.trim();E.ChangeLogin(e).then((e=>{if(e.ok)nav.innerHTML="",super.render(),i.emit("loginPasswordChange",e);else{const t=document.createElement("div");t.className="error",t.textContent=e.errmsg,s.appendChild(t)}}))}}));const o={head:!1},l=new x(o,[{type:"password",name:"password",text:"Старый пароль",required:!0,valid:!1},{type:"password",name:"password",text:"Новый пароль",required:!0,valid:!0,reg:/.{8,16}/,errorVal:"Недопустимый первый пароль(Должен быть от 8 до 16 символов)"},{type:"password",name:"password",text:"Повторите новый пароль",required:!0,valid:!0,reg:/.{8,16}/,errorVal:""}],{text:"Изменить пароль",className:"secondary"}).render(),c=l[0];this.parent.appendChild(c);const d=new e(c),m=document.createElement("div");m.className="error",d.render("submit",(()=>{if(!l[2].classList.contains("invalid")||!l[3].classList.contains("invalid")){const e=l[1].value.trim(),t=l[2].value.trim();t===l[3].value.trim()?E.ChangePassword(e,t).then((e=>{console.log(e.ok),e.ok?i.emit("loginPasswordChange",e):(m.textContent=e.errmsg,c.appendChild(m))})):(m.innerHTML="Пароли не совпадают",c.appendChild(m))}}));const u=new x(o,[{type:"file",name:"file",text:"фото",required:!0,valid:!1}],{text:"Изменить аватар",className:"secondary"}).render(),p=u[0];this.parent.appendChild(p);const h=new FormData;new e(p).render("submit",(()=>{h.append("file",u[1].files[0]),E.ChangeAvatar(h).then((e=>{e.ok?(super.render(!0),i.emit("main")):(m.textContent=e.errmsg,p.appendChild(m))}))}));const g=new r({parent:this.parent,classname:"buttons buttons__marginForFilmCard",text:"Назад"});i.emit("Back",g)}}class L{constructor(e={}){const{title:t,MainGenre:n,year:a,SmallImg:s,id:r}=e;this.title=t,this.genre=n,this.image=s,this.year=a,this.id=r,this.poster=document.createElement("div"),this.template=Handlebars.templates.FilmPoster}render(){return this.template({id:this.id,title:this.title,MainGenre:this.genre,year:this.year,SmallImg:this.image})}}class H{constructor(e={}){const{genre:t,parent:n,body:a}=e;this.genre=t,this.parent=n,this.body=a,this.lenta=document.createElement("div"),this.template=Handlebars.templates.FilmLenta;const s=[];for(let e=0;e<this.body.length;e++){const t=new L(this.body[e]);s[e]=t.render()}this.posters=s}render(){this.parent.appendChild(this.lenta),this.lenta.innerHTML=this.template({genre:this.genre,posters:this.posters})}}class j extends p{constructor(e){super(nav),this.parent=e}render(){super.render(!1),this.parent.innerHTML="",this.parent.className="",document.getElementById("body").className="main__black",navigator.onLine||(document.createElement("div").textContent="Нет подключения к интернету, но не беда! Можете посмотреть на лучшие фильмы на данный момент!",nav.insertAdjacentHTML("afterend","Нет подключения к интернету, но не беда! Можете посмотреть на лучшие фильмы на данный момент!"));const e=[{rusGenre:"Фантастика",genre:"fantasy",parent:this.parent},{rusGenre:"Комедии",genre:"comedy",parent:this.parent}];for(let t=0;t<e.length;t++){let n;f.getByGenre(e[t].genre).then((a=>{try{n=JSON.parse(JSON.stringify(a.get))}catch(e){return void this.menuPage()}a.ok?new H({genre:e[t].rusGenre,body:n,parent:application}).render():this.menuPage()}))}}}class I{constructor(e={}){const{body:t,parent:n}=e;this.card=document.createElement("div"),this.parent=n,this.body=t,this.template=Handlebars.templates.PersonCard}render(){this.parent.appendChild(this.card),this.card.innerHTML=this.template({Name:this.body.Name,Image:this.body.Image,BornDate:this.body.BornDate,BornPlace:this.body.BornPlace})}}class N extends p{constructor(e){super(nav);const{parent:t,id:n}=e;this.parent=t,this.id=n}render(){let e;super.render(!1),document.getElementById("body").className="film1",this.parent.innerHTML="",v.getById(this.id).then((t=>{try{e=JSON.parse(JSON.stringify(t.get))}catch(e){return void i.emit("main")}t.ok?new I({parent:this.parent,body:e}).render():this.menuPage()})),f.getByPerson(this.id).then((e=>{let t;try{t=JSON.parse(JSON.stringify(e.get))}catch(e){return void i.emit("main")}e.ok?(console.log(t),new H({genre:"Фильмы с участием этого актера",body:t,parent:application}).render()):this.menuPage()}))}}class M extends p{constructor(e){const{parent:t,genre:n}=e;super(nav),this.parent=t,this.genre=n,this.map=[],this.map.fantasy="Фантастика",this.map.comedy="Комедии"}render(){let e;super.render(!1),this.parent.innerHTML="",document.getElementById("body").className="page",f.getByGenre(this.genre).then((t=>{try{e=JSON.parse(JSON.stringify(t.get))}catch(e){return void i.emit("main")}t.ok?new H({genre:this.getRussian(this.genre),body:e,parent:this.parent}).render():i.emit("main")}))}getRussian(e){return this.map[e]}}class O{static menuPage(){new j(application).render()}static signupPage(){d.me().then((e=>{e.ok?i.emit("main"):new C(application).render()}))}static filmPage(e){const{id:t}=e;let n,a=!1;d.me().then((e=>{console.log(e),a=!!e.ok,f.getById(t).then((e=>{try{n=JSON.stringify(e.get)}catch(e){return void this.menuPage()}e.ok?new b({parent:application,body:n,isAuthorized:a}).render():this.menuPage()}))}))}static loginPage(){d.me().then((e=>{e.ok?i.emit("main"):new k(application).render()}))}static profileChengePage(){let e;application.innerHTML="",d.me().then((t=>{try{e=JSON.stringify(t.get)}catch(e){return void this.menuPage()}t.ok?new B(application,e).render():this.loginPage()}))}static profilePage(){let e;application.innerHTML="",d.me().then((t=>{try{e=JSON.stringify(t.get)}catch(e){return void this.menuPage()}t.ok?new _(application,e).render():this.loginPage()}))}static personPage(e){const{id:t}=e;new N({parent:application,id:t}).render()}static genrePage(e){const{id:t}=e;new M({parent:application,genre:t}).render()}}const F=document.getElementById("app"),T=document.getElementById("navbar");window.application=F,window.nav=T,"serviceWorker"in navigator&&navigator.serviceWorker.register("sw.js",{scope:"/"}).then((e=>{console.log("sw registration on scope:",e.scope)})).catch((e=>{console.error(e)})),i.on("profile",(e=>{e.render("click",(()=>{S.open("/profile")}))})),i.on("profileChange",(e=>{e.render("click",(()=>{S.open("/profileChange")}))})),i.on("film",(e=>{e.render("click",(()=>{S.open("/film",{id:1})}))})),i.on("navbarLogin",(e=>{e.render((()=>{S.open("/login")}))})),i.on("navbarSignup",(e=>{e.render((()=>{S.open("/signup")}))})),i.on("logout",(e=>{e.ok?S.open("/"):console.log(e.errmsg)})),i.on("navbarClick",(e=>{e.render("click",(()=>{}))})),i.on("loginSignup",(e=>{const{loginres:t,err:n,form:a,render:s}=e;t.ok?(T.innerHTML="",S.open("/")):(n.innerHTML=t.errmsg,a.appendChild(n))})),i.on("loginPasswordChange",(e=>{S.open("/profile")})),i.on("Change",(e=>{S.open("/profileChange")})),i.on("Back",(e=>{e.render((()=>{window.history.back()}))})),i.on("main",(()=>{S.open("main")}));const G=document.getElementById("body"),S=new class{constructor(e){this.routes={},this.root=e}register(e,t){return this.routes[e]=t,this}open(e,t={}){const{id:n}=t,a=this.routes[e];let s=e;a?(null!=n&&""!=n&&(s=s+"/"+n),console.log("sss",s),window.location.pathname!==s&&window.history.pushState(null,"",s),a({id:n})):this.open("/")}start(){this.root.addEventListener("click",function(e){if(!(e.target instanceof HTMLAnchorElement||e.target instanceof HTMLImageElement))return;e.preventDefault();const t=e.target;let n;if(n=t instanceof HTMLImageElement?t.parentNode:t,-1!==n.pathname.indexOf("undefined"))return;let a=this.split(n.pathname);this.open(a.path,{id:a.param})}.bind(this)),window.addEventListener("popstate",(e=>{const t=window.location.pathname;let n=this.split(t);this.open(n.path,{id:n.param})}));let e=window.location.pathname;console.log(e);let t=this.split(e);this.open(t.path,{id:t.param})}split(e){let t,n,a,s="",r=0;for(a=0;a<e.length;a++)"/"==e[a]&&r++;if(r>2){for(a=1;"/"!=e[a];a++);e=e.substring(a)}for(n=1;"/"!==e[n]&&n<e.length;n++);return t=e.substring(0,n),n===e.length||(s=e.substring(n+1)),{path:t,param:s}}}(G);S.register("/",O.menuPage).register("/login",O.loginPage).register("/film",O.filmPage).register("/signup",O.signupPage).register("/profile",O.profilePage).register("/profileChange",O.profileChengePage).register("/person",O.personPage).register("/genre",O.genrePage),S.start()})()})();